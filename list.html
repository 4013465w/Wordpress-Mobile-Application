<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>菜单</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="css/mui.min.css">
	</head>

	<body>
		<!--下拉刷新容器-->
		<div id="pullrefresh" class="mui-content mui-scroll-wrapper">
			<div class="mui-scroll">
				<!--数据列表-->
				<ul class="mui-table-view">
					<my-img-list v-for="item in imglist" :id="item.id" :title="item.title.rendered" :excerpt="item.excerpt.rendered" >

					</my-img-list>
				</ul>
			</div>
		</div>
		<script src="./js/mui.min.js"></script>
		<script type="text/javascript" src="js/vue.js"></script>
		<script type="text/javascript" src="js/app.js"></script>
		<script>
			var wp = new WP();
			/*
			 * VUE
			 */
			var list = new Vue({
				el: 'body',
				data: {
					imglist: new Array(),
					page: 1,
					catid:''
				},
				methods: {
					pullupRefresh: function() {
 						wp.getData({
							route: 'posts',
							data: {
								page: this.page++,
								'filter[cat]':this.catid
								
							},
							success: function(data) {
								var next = data.length < app.per_page ? 1 : 0;
								console.log('da'+data.length+'d'+ app.per_page+'n'+next)
								
								list.imglist = list.imglist.concat(data);
								
								mui('#pullrefresh').pullRefresh().endPullupToRefresh(next);
								//									console.log('上');
							},
							error: function() {
								mui('#pullrefresh').pullRefresh().endPullupToRefresh(0);
							}
						})
					},
					pulldownRefresh: function() {
						this.page=1;
						wp.getData({
							route: 'posts',
							data: {
								page: this.page++,
								context: 'embed',
								'filter[cat]':this.catid
							},
							success: function(data) {
								var next = data.length < app.per_page ? 1 : 0;
								console.log('da'+data.length+'d'+ app.per_page+'n'+next)
								
								list.imglist = data;
								mui('#pullrefresh').pullRefresh().endPulldownToRefresh(next);
							},
							error: function() {
								mui('#pullrefresh').pullRefresh().endPulldownToRefresh(0
								
								);
							}
						})
						console.log('下拉')
					}
				},
				components: {
					'my-img-list': MyImgList
				}
			})
			mui.init({
				preloadPages: [{
					url: 'detail.html',
					id: 'detail.html'
				}],
				pullRefresh: {
					container: '#pullrefresh',
					down: {
						callback: list.pulldownRefresh
					},
					up: {
						contentrefresh: '正在加载...',
						callback: list.pullupRefresh
					}
				}
			});
			/*
			 * 监听点击事件
			 */
			mui(".mui-table-view").on('tap', '.mui-table-view-cell', function() {
				//获取id
				var id = this.getAttribute("data-id");
				var detail_page = plus.webview.getWebviewById('detail.html');
				mui.fire(detail_page, 'getDetail', {
					id: id
				});
				//打开新闻详情
				mui.openWindow({
					id: 'detail.html',
				}); //打开新闻详情
			})
			mui.plusReady(function() {
				var main = plus.webview.getLaunchWebview();
				var listpage = plus.webview.getWebviewById('list.html');
				listpage.addEventListener('maskClick', closeMenu);
				var isInTransition = false;
				var showMenu = false;
				/**
				 * 显示侧滑菜单
				 */
				function openMenu() {
					if (isInTransition) {
						return;
					}
					if (!showMenu) {
						mui.fire(main, 'menu:hide');
						//侧滑菜单处于隐藏状态，则立即显示出来；
						isInTransition = true;
						main.setStyle({
							mask: 'rgba(0,0,0,0)'
						}); //menu设置透明遮罩防止点击
						//主窗体开始侧滑并显示遮罩
						listpage.setStyle({
							mask: 'rgba(0,0,0,0)',
							left: '40%',
							transition: {
								duration: 150
							}
						});
						mui.later(function() {
							isInTransition = false;
							main.setStyle({
								mask: "none"
							}); //移除menu的mask
							listpage.setStyle({
								mask: 'rgba(0,0,0,0.4)'
							})
						}, 160);
						showMenu = true;
					}
				};
				/**
				 * 关闭菜单
				 */
				function closeMenu() {
					if (isInTransition) {
						return;
					}
					if (showMenu) {
						mui.fire(main, 'menu:hide');
						//关闭遮罩；主窗体开始侧滑；
						isInTransition = true;
						listpage.setStyle({
							mask: 'none',
							left: '0',
							transition: {
								duration: 200
							}
						});
						showMenu = false;
						isInTransition = false;
					}
				};
				//主界面向右滑动，若菜单未显示，则显示菜单；否则不做任何操作
				window.addEventListener("swiperight", openMenu);
				//主界面向左滑动，若菜单已显示，则关闭菜单；否则，不做任何操作；
				window.addEventListener("swipeleft", closeMenu);
				//侧滑菜单触发关闭菜单命令
				window.addEventListener("menu:close", closeMenu);
				window.addEventListener("menu:open", openMenu);
				window.addEventListener("menu", function() {
					if (showMenu) {
						closeMenu();
					} else {
						openMenu();
					}
				});
				window.addEventListener('reload', function(event) {
					list.catid = event.detail.catid;
					closeMenu();
					mui('#pullrefresh').pullRefresh().pulldownLoading();
				})
			})
			if (mui.os.plus) {
				mui.plusReady(function() {
					setTimeout(function() {
						mui('#pullrefresh').pullRefresh().pullupLoading();
					}, 1000);
				});
			} else {
				mui.ready(function() {
					mui('#pullrefresh').pullRefresh().pullupLoading();
				});
			}
		</script>
	</body>

</html>